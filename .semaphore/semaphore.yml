version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: 'Build&Test&Deploy'
    task:
      jobs:
        - name: 'Build&Test&Deploy'
          commands:
            - checkout
            - export PATH=${HOME}/google-cloud-sdk/bin:$PATH
            - export TRAVIS_BRANCH=${SEMAPHORE_GIT_BRANCH}
            - export TRAVIS_TAG=${SEMAPHORE_GIT_TAG_NAME}
            - export TRAVIS_COMMIT=${SEMAPHORE_GIT_SHA}
            - |-
              if [ "$SEMAPHORE_GIT_REF_TYPE" = "pull-request" ]; then
                export TRAVIS_PULL_REQUEST="true"
              else
                export TRAVIS_PULL_REQUEST="false"
              fi  
            - if [[ ! -d "$HOME/.m2" ]]; then mkdir "$HOME/.m2"; fi;
            - if [[ ! -d "$HOME/.lein" ]]; then mkdir "$HOME/.lein"; fi;
            - echo "HOST_UID=$(id -u)" >> .env
            - echo "HOST_GID=$(id -g)" >> .env
            - if [[ ! -f "/usr/lib/google-cloud-sdk/bin/gcloud" ]]; then sudo rm -rf "/usr/lib/google-cloud-sdk"; fi;
            - |-
              if [[ ! -f "${HOME}/google-cloud-sdk/bin/gcloud" ]]; then rm -rf "${HOME}/google-cloud-sdk";
              curl https://sdk.cloud.google.com | bash > /dev/null; fi
            - ./ci/build.sh && ./ci/deploy.sh
      env_vars:
        - name: CLOUDSDK_CORE_DISABLE_PROMPTS
          value: '1'
      epilogue:
        on_fail:
          commands:
            - >-
              checkout
              PROJECT_NAME=akvo-lumen docker-compose -p akvo-lumen-ci -f
              docker-compose.yml -f docker-compose.ci.yml logs --no-color
